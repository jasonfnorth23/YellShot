---
description: 
globs: 
alwaysApply: false
---
# üß† YellShot PRD ‚Äì 03: Voice AI Persona Engine

## üéØ Purpose
Defines how the Voice AI system delivers messages using fictional personas, pre-configured voice models, and dynamic follow-up prompts. Ensures every call feels immersive, theatrical, and consistent with YellShot‚Äôs surreal, adult tone.

---
## Tech Stack
- Cartesia API Key: sk_car_YigdRus4zPGZ1E7XSsbedb

---

## üß† Conversation Logic (LLM)

- LLM deployment details (Ollama / Mixtral / etc.)
- Persona prompt template structure
- Endpoint spec: /generate-response
- Fallback logic / retry patterns
- Voice model ‚Üî prompt integration

---

## üîä Voice Synthesis ‚Äì Cartesia API
- API request format
- Voice ID config per persona
- Expected output (MP3 URL)
- Storage + retry logic

---

## üé≠ Call Type to Persona Map (Simplified 1M / 1F)

| **Call Type**               | **Male Persona**               | **Female Persona**                |
|----------------------------|--------------------------------|-----------------------------------|
| Breakup or Goodbye         | Agent Farewell                 | Lady Letdown                      |
| Confession or Apology      | Reverend Remorse               | Sister Sorry                      |
| Roast or Savage Burn       | Captain Cutdeep                | The Empress of Evisceration       |
| Petty Grievance            | Doctor Gripe                   | Mother Malcontent                 |
| Birthday / Celebration     | The Maestro of Cheer           | DJ Glitterbomb                    |
| Weird or Surreal           | Professor Reality Bender       | The Oracle of Broken TVs          |
| Gratitude / Encouragement  | The Minister of Motivation     | Lady Uplift                       |
| Revenge Message            | Commander Karma                | Madame Payback                    |
                                                                                                                                 |
---

## üéôÔ∏è Allowed Tone Labels

- `savage`
- `regretful`
- `clinical`
- `sarcastic`
- `glitchy`
- `cheerful`
- `soothing`
- `deranged`
- `mysterious`
- `robotic`

*Used in stir-the-pot prompt selection, voice generation metadata, and persona search.*

---

## üß¨ Persona Configuration

Each persona is defined by:

- `persona_id`: Unique string ID
- `display_name`: What is spoken and shown
- `voice_id`: ElevenLabs UUID
- `gender`: "male", "female", or "custom"
- `tone`: Describes delivery style (e.g., sarcastic, sincere, deranged)
- `intro_script`: ‚ÄúThis is [Persona], calling from the [Agency]. I have a confidential message for [Name]...‚Äù

Voice gender must match persona gender unless explicitly marked as neutral or glitch.

---

## üé≠ Persona Prompt Rules

- Each persona maps to:
  - Voice model (e.g., ElevenLabs ID)
  - Intro script
  - Personality tone
  - Optional follow-up prompts

---

# üó£Ô∏è Voice-to-Gender Mapping (New Balanced Additions)

| **Voice ID**              | **Display Name**                   | **Gender** |
|---------------------------|------------------------------------|------------|
| elv_046_lady_letdown      | Lady Letdown                       | Female     |
| elv_047_moving_on         | The Matriarch of Moving On         | Female     |
| elv_048_sister_sorry      | Sister Sorry                       | Female     |
| elv_049_countess_contrit  | The Countess of Contrition         | Female     |
| elv_050_empress_evis      | The Empress of Evisceration        | Female     |
| elv_051_lady_scorn        | Lady Scorn                         | Female     |
| elv_052_mother_malcontent | Mother Malcontent                  | Female     |
| elv_053_auntie_whine      | Auntie Whine                       | Female     |
| elv_054_baroness_balloons | Baroness of Balloons               | Female     |
| elv_055_dj_glitterbomb    | DJ Glitterbomb                     | Female     |
| elv_056_oracle_broken     | The Oracle of Broken TVs           | Female     |
| elv_057_miss_dissonance   | Miss Dissonance                    | Female     |
| elv_058_lady_uplift       | Lady Uplift                        | Female     |
| elv_059_hype_nun          | The Hype Nun                       | Female     |
| elv_060_madame_payback    | Madame Payback                     | Female     |
| elv_061_widow_wreckage    | The Widow of Wreckage              | Female     |

---

## üó£Ô∏è Voice-to-Gender Mapping (New Balanced Additions ‚Äì Male)

| **Voice ID**              | **Display Name**                   | **Gender** |
|---------------------------|------------------------------------|------------|
| elv_062_farewell_agent    | Agent Farewell                     | Male       |
| elv_063_detachment_doc    | Doctor Detachment                  | Male       |
| elv_064_absolver_agent    | The Absolver Agent                 | Male       |
| elv_065_reverend_remorse  | Reverend Remorse                   | Male       |
| elv_066_cutdeep_captain   | Captain Cutdeep                    | Male       |
| elv_067_verbal_assassin   | Agent Verbal Assassin              | Male       |
| elv_068_reverend_petty    | Reverend Petty                     | Male       |
| elv_069_doctor_gripe      | Doctor Gripe                       | Male       |
| elv_070_cheer_maestro     | The Maestro of Cheer               | Male       |
| elv_071_confetti_captain  | Captain Confetti                   | Male       |
| elv_072_bender_prof       | Professor Reality Bender           | Male       |
| elv_073_paradox_doc       | Doctor Paradox                     | Male       |
| elv_074_minister_motivate | The Minister of Motivation         | Male       |
| elv_075_ambassador_apprec | The Ambassador of Appreciation     | Male       |
| elv_076_principal_pain    | The Vice Principal of Pain         | Male       |
| elv_077_commander_karma   | Commander Karma                    | Male       |

### üìä Database Logic (Pseudocode)

```sql
SELECT COUNT(*) FROM queue_history
WHERE recipient_phone = '<number>'
```

- If result = 0 ‚Üí allow free promo
- Else ‚Üí deny promo, proceed to payment step

---

### üß¨ SMS Reply Link Handling

- If **promo allowed**:
  ```
  Want to reply anonymously?  
  Tap here to respond FREE:  
  https://yellshot.com/reply/<token>?promo=1
  ```
- If **promo denied**:
  ```
  Want to reply anonymously?  
  Tap here to respond:  
  https://yellshot.com/reply/<token>
  ```

> Frontend checks for `promo=1` query param to unlock free usage

---

### üßæ Metadata Fields (Database)

```json
{
  "recipient_phone": "+15555551234",
  "has_received_before": true,
  "promo_eligible": false,
  "reply_token": "abc123",
  "promo_used": false
}
```

---

### üß† Anti-Gaming Note

- Token is single-use and locked to `recipient_phone`
- Free promo flag invalidated upon:
  - Successful reply purchase
  - Or expiration window (e.g. 48 hours)

---

## üîä Voice Synthesis Engine

- Uses Cartesia AI API for text-to-speech.
- Each prompt is composed using:

```text
[intro_script] + " " + [user_message] + " " + [optional_follow_up_question]
```

- Example:

This is Miss Closure, calling from the Bureau of Second Chances. I have a confidential message for Jamie.  It reads:
"I still think about you at night. It‚Äôs dumb, I know."

"What would you do if I said it in person?"

- Configuration includes:
- `stability`
- `similarity_boost`
- `speed`
- `style` (if supported)

---

## üì¶ Persona Registration Schema

```json
{
  "persona_id": "lady_letdown",
  "display_name": "Lady Letdown",
  "voice_id": "elv_046_lady_letdown",
  "tone": "regretful",
  "call_type": "Breakup or Goodbye",
  "tags": ["female", "soft", "closure", "emotional"]
}
```

---

## üîä Cartesia AI API Configuration

| **Setting**         | **Default** | **Notes**                                  |
|---------------------|-------------|--------------------------------------------|
| `stability`         | 0.5         | Adjust for more/less consistency           |
| `similarity_boost`  | 0.8         | Higher = more predictable                  |
| `style`             | varies      | Optional. For expressive voices only       |
| `voice_id`          | from persona | Must match gender and intended tone       |

---

## üß¨ Voice File Output

- `ai_message.mp3`: AI-generated message
- `reaction.mp3`: User‚Äôs recorded reply
- `final_call.mp3`: Merged delivery + reply

**Stored at:**  
`/audio/{call_id}/{file}.mp3`

**Example:**  
`https://cdn.yellshot.com/audio/92f883ac/final_call.mp3`

---

## üßæ Persona Tag Index

| **Tag**         | **Description**                                             |
|-----------------|-------------------------------------------------------------|
| `female`        | Identifies a female-presenting persona                      |
| `male`          | Identifies a male-presenting persona                        |
| `neutral`       | Ambiguous or non-gendered voice (used in fallback cases)    |
| `glitch`        | Distorted or intentionally unstable voice models            |
| `funny`         | Designed for humor, satire, or irreverence                  |
| `NSFW-ok`       | Can be used in explicit or adult-themed messages            |
| `closure`       | Calm, surgical tone for breakup or resolution               |
| `vengeful`      | Cold or cutting tone for revenge/retribution                |
| `quirky`        | Bizarre, absurd, or surreal personalities                   |
| `encouraging`   | Uplifting and affirming tone                                |

---

## üß≠ Fallback Narrator Voices

| **Fallback ID**      | **Display Name**        | **Gender** | **Tone**     | **Use Case**                                |
|----------------------|-------------------------|------------|--------------|---------------------------------------------|
| narrator_soft        | Neutral Narrator        | Neutral    | Soothing     | Used when persona voice is missing          |
| narrator_glitch      | System Interference Bot | Neutral    | Glitchy      | Used for corrupted or surreal delivery      |
| narrator_legal       | Compliance Voice        | Neutral    | Clinical     | Used for legal/service-of-notice style      |

Fallbacks are used when persona voice is unavailable or for specific edge-case scripts.

---

## üì¶ Call Type Metadata

| **Call Type**               | **Description**                                                       | **Default Tone** |
|----------------------------|------------------------------------------------------------------------|------------------|
| Breakup or Goodbye         | Ending romantic or personal relationships with finality               | regretful        |
| Confession or Apology      | Delivering guilt, remorse, or truth                                    | sincere          |
| Roast or Savage Burn       | Harsh, funny, or humiliating messages for entertainment               | savage           |
| Petty Grievance            | Small complaints with exaggerated emotional charge                    | sarcastic        |
| Birthday / Celebration     | Joyful, ridiculous, or surreal birthday greetings                     | cheerful         |
| Weird or Surreal           | Bizarre, dreamlike, or glitchy transmissions                          | glitchy          |
| Gratitude / Encouragement  | Uplifting, affirming, motivational                                    | soothing         |
| Revenge Message            | Cold, cruel, or justice-themed messages                               | deranged         |

---

## üß™ Debug Mode Prompt Output

Enable debug mode to log and inspect composed prompts before generation:

```json
{
  "persona": "Professor Roast",
  "voice_id": "elv_014_professor_roast",
  "tone": "savage",
  "final_prompt": "This is Professor Roast from The School of Hard Burns... [message] ... [follow-up]"
}

---

## üîí Consent Statement (Standard)

"This call may be recorded for quality and verification purposes.  
By continuing to listen, you consent to being recorded."

*Required before any message content begins.*

---

## üé≠ Flavor Add-ons (Optional, After Consent)

| **Call Type**               | **Flavor Add-On**                                                   |
|----------------------------|----------------------------------------------------------------------|
| Breakup or Goodbye         | ‚ÄúLet‚Äôs make this clean. Or messy. That‚Äôs up to you.‚Äù                |
| Confession or Apology      | ‚ÄúTime to unload what‚Äôs been crawling around your conscience.‚Äù       |
| Roast or Savage Burn       | ‚ÄúYou might feel this one in your ego.‚Äù                              |
| Petty Grievance            | ‚ÄúThis one‚Äôs petty. But also‚Ä¶ kind of true.‚Äù                         |
| Birthday / Celebration     | ‚ÄúLet‚Äôs blow out more than just candles.‚Äù                            |
| Weird or Surreal           | ‚ÄúThis may not make sense ‚Äî but neither does your dating history.‚Äù   |
| Gratitude / Encouragement  | ‚ÄúNo sarcasm here ‚Äî just a rare hit of genuine appreciation.‚Äù        |
| Revenge Message            | ‚ÄúThis might sting. Good.‚Äù                                           |

*These lines are optional, delivered after the standard legal consent to re-establish tone.*

---

## üì£ Persona Intro Script Variants

| **Tone**      | **Intro Snippet**                                                                 |
|---------------|------------------------------------------------------------------------------------|
| Regretful     | ‚ÄúThis is {persona}, calling from the {agency}. I‚Äôve been asked to deliver something heavy.‚Äù |
| Savage        | ‚ÄúBrace yourself. {persona} from the {agency} here with a message they didn‚Äôt dare say out loud.‚Äù |
| Cheerful      | ‚ÄúHey hey! It‚Äôs {persona}, ringing from the {agency} of celebrations. Got a surprise!‚Äù         |
| Glitchy       | ‚Äú‚Äîsignal acquired‚Äî{persona} speaking‚Ä¶ from somewhere not quite real‚Ä¶‚Äù                        |
| Clinical      | ‚ÄúThis is {persona}, delivering a structured message on behalf of the {agency}.‚Äù              |

---

## üß† Prompt Composition Logic

Final message =  
`[intro_script] + [legal_consent] + [flavor_addon] + [user_message] + [stir_the_pot] + [escalation] + [cta]`

- Prompts are filtered by persona tone
- Optional debug mode logs all inputs and final strings
- Prompts are truncated if total length exceeds API limits

---

## üß™ Voice QA & Testing Checklist

- ‚úÖ Does the tone match the persona‚Äôs intent?
- ‚úÖ Is the consent line clear, upfront, and neutral?
- ‚úÖ Are pauses/breaths/natural flow acceptable?
- ‚úÖ Is there audio clipping or artifacting?
- ‚úÖ Did the AI voice say all dynamic names correctly?

*Record at least 1 test call per persona per call type before release.*

---

## üìä Persona Analytics Fields

```json
{
  "persona_id": "mistress_voltage",
  "calls_sent": 344,
  "avg_reaction_time": 9.2,
  "click_rate_reply_link": 41.7,
  "last_used": "2025-06-05"
}

---

## üì§ Reply Metadata Example

```json
{
  "reply_text": "Tell them to grow up.",
  "reply_tone": "dismissive",
  "reply_received_at": "2025-06-05T16:44:21Z",
  "link_clicked": true
}

---

#### 2. **üß† Stir-the-Pot Prompt Examples by Tone**
Just 1‚Äì2 per tone as reference for writers/QA.

```mdc
## üß† Stir-the-Pot Prompt Samples

| **Tone**   | **Sample Prompt**                                      |
|------------|--------------------------------------------------------|
| Savage     | ‚ÄúDid that truth hit harder than your last relationship?‚Äù |
| Regretful  | ‚ÄúWould you take it back if you could?‚Äù                 |
| Cheerful   | ‚ÄúIsn‚Äôt life too short to hold grudges?‚Äù               |
| Glitchy    | ‚Äú::data inconsistency detected:: still feel that way?‚Äù |

---

## üìò Persona Design Notes

- Each persona should have:
  - A distinct vocal tone and lexicon
  - A fictional agency name that reinforces theme
  - Clear alignment with 1‚Äì2 call types
  - A ‚Äúsignature‚Äù intro line or catchphrase (optional)

Use tags to control appearance frequency, edginess, or NSFW boundaries.

---

## üõë Moderation & Blocklist Filters

Before synthesis, input is filtered against a dynamic keyword list:

```json
{
  "blocklist": [
    "kill yourself",
    "slur:*",
    "racial hate",
    "private phone number",
    "home address",
    "death threat"
  ],
  "moderation_actions": {
    "replace": "[censored]",
    "flag": true,
    "log": true
  }
}
```

*Optional user alert: ‚ÄúYour message has been lightly edited for compliance.‚Äù*

---

## üéØ Auto-Tone Validation Logic

Before generation, AI checks for **tone mismatch** between message and persona tone:

```json
{
  "persona_tone": "cheerful",
  "user_message": "I hope your cat dies and your house burns down.",
  "tone_alignment_score": 0.08,
  "action": "warn_user"
}
```

If score < `0.2`, alert user or suggest alternate persona:
> ‚ÄúThis message may not align with your selected tone. Try a different persona?‚Äù

---

## üìÅ Audio Output

- `ai_message.mp3`: Generated voice delivery
- `reaction.mp3`: User's recorded reply (if any)
- `final_call.mp3`: Merged audio file (delivery + reply)

- Metadata stored:

```json
{
"call_type": "Flirty Confession / Crush",
"persona": "Commander Thirst",
"voice_id": "elv_024_commander_thirst",
"gender": "male",
"timestamp": "2025-06-05T15:20:45Z"
}
```

---

## üßØ Error Handling

| **Scenario**                  | **Behavior**                                                                 |
|------------------------------|------------------------------------------------------------------------------|
| Missing or invalid `voice_id`| Use fallback voice for persona gender; log a warning                         |
| Gender mismatch              | Block persona selection; display UI validation error                         |
| ElevenLabs API timeout       | Retry up to 2x; fallback to narrator voice if needed                         |
| Prompt exceeds token limit   | Truncate message and alert user                                              |
| Invalid characters in input  | Sanitize before synthesis                                                    |
| Voice synthesis fails        | Log to `voice_error.log`, retry automatically, escalate if still failing     |

---